<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>步骤3 - 补充公司资料</title>
  <link rel="stylesheet" href="../assets/css/shared.css">
  <style>
    #markdownPreview {
      line-height: 1.6;
    }
    #markdownPreview h1 {
      font-size: 2em;
      font-weight: bold;
      margin: 1em 0 0.5em 0;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 0.5em;
    }
    #markdownPreview h2 {
      font-size: 1.5em;
      font-weight: bold;
      margin: 1em 0 0.5em 0;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.3em;
    }
    #markdownPreview h3 {
      font-size: 1.25em;
      font-weight: bold;
      margin: 0.8em 0 0.4em 0;
    }
    #markdownPreview p {
      margin: 0.5em 0;
    }
    #markdownPreview ul, #markdownPreview ol {
      margin: 0.5em 0;
      padding-left: 2em;
    }
    #markdownPreview li {
      margin: 0.3em 0;
    }
    #markdownPreview code {
      background-color: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    #markdownPreview pre {
      background-color: #f3f4f6;
      padding: 1em;
      border-radius: 8px;
      overflow-x: auto;
      margin: 1em 0;
    }
    #markdownPreview pre code {
      background-color: transparent;
      padding: 0;
    }
    #markdownPreview blockquote {
      border-left: 4px solid #3b82f6;
      padding-left: 1em;
      margin: 1em 0;
      color: #6b7280;
    }
    #markdownPreview table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    #markdownPreview table th,
    #markdownPreview table td {
      border: 1px solid #e5e7eb;
      padding: 0.5em;
      text-align: left;
    }
    #markdownPreview table th {
      background-color: #f9fafb;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="../index.html" class="text-blue-600 underline text-sm">返回主页</a>
    <h1 class="text-2xl font-bold mb-4">步骤3：补充公司资料</h1>

    <div class="card space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2">选择公司信息</label>
        <input type="file" id="fileInput" class="input" accept=".doc,.docx,.pdf,.txt,.md">
        <p class="text-xs text-gray-500 mt-1">支持 Word、PDF、TXT、MD，≤50MB</p>
      </div>

      <div>
        <label class="block text-sm font-medium mb-2">说明（可选）</label>
        <textarea id="userReq" class="input" rows="4" placeholder="请输入重点需求或补充说明"></textarea>
      </div>

      <div class="flex space-x-2">
        <button id="runBtn" class="btn btn-primary">提交</button>
      </div>

      <div>
        <div class="flex items-center justify-between mb-2">
          <label class="block text-sm font-medium"><h2>输出公司信息：</h2></label>
           </div>
        <div id="previewMode">
          <div id="markdownPreview" class="input p-4" style="min-height: 300px; overflow-y: auto;"></div>
        </div>
        <div id="editMode" class="hidden">
          <textarea id="resultArea" class="input" rows="14" placeholder="结果将显示在此"></textarea>
        </div>
      </div>
      <div class="flex space-x-2">
        <button id="editBtn" class="btn btn-secondary text-sm">编辑模式</button>
        <button id="saveBtn" class="btn btn-secondary">保存修改并下一步</button>
        <button id="nextBtn" class="btn">直接下一步</button>
      </div>
    </div>
  </div>

  <script src="../assets/js/store.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/ui.js"></script>
  <script src="../assets/js/api.js"></script>
  <!-- Markdown 渲染库 -->
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const userReq = document.getElementById('userReq');
    const runBtn = document.getElementById('runBtn');
    const saveBtn = document.getElementById('saveBtn');
    const nextBtn = document.getElementById('nextBtn');
    const editBtn = document.getElementById('editBtn');
    const resultArea = document.getElementById('resultArea');
    const previewMode = document.getElementById('previewMode');
    const editMode = document.getElementById('editMode');
    const markdownPreview = document.getElementById('markdownPreview');

    // 渲染 Markdown 预览
    function renderMarkdownPreview() {
      const markdown = resultArea.value;
      if (marked) {
        markdownPreview.innerHTML = marked.parse(markdown);
      } else {
        markdownPreview.textContent = markdown;
      }
    }

    // 读取已有状态
    const state = Store.getState();
    if (state.step3Result) {
      resultArea.value = Utils.getResultContent(state.step3Result);
      renderMarkdownPreview();
    }
    if (state.step3UserReq) userReq.value = state.step3UserReq;

    // 初始化：默认预览模式，保存按钮禁用
    saveBtn.disabled = true;

    // 编辑按钮点击事件
    editBtn.addEventListener('click', () => {
      if (editMode.classList.contains('hidden')) {
        // 切换到编辑模式
        editMode.classList.remove('hidden');
        previewMode.classList.add('hidden');
        editBtn.textContent = '预览模式';
        // 启用保存按钮
        saveBtn.disabled = false;
      } else {
        // 切换到预览模式
        renderMarkdownPreview();
        editMode.classList.add('hidden');
        previewMode.classList.remove('hidden');
        editBtn.textContent = '编辑模式';
        // 禁用保存按钮
        saveBtn.disabled = true;
      }
    });

    runBtn.addEventListener('click', async () => {
      try {
        if (!fileInput.files.length) {
          UI.showError('请先选择公司资料文件');
          return;
        }
        const file = fileInput.files[0];
        if (file.size > 50 * 1024 * 1024) {
          UI.showError('文件不能超过50MB');
          return;
        }
        const apiKey = API.DIFY_CONFIG.apiKeys.step3;
        const fileType = API.getFileType(file);
        const fileCategory = API.getFileCategory(fileType);
        const uploadId = await API.uploadFileToDify(file, fileType, apiKey);

        const inputs = {};
        const companyKey = API.DIFY_CONFIG.inputKeys.step3CompanyKey || 'company_files';
        inputs[companyKey] = [{
          transfer_method: 'local_file',
          upload_file_id: uploadId,
          type: fileCategory || 'document'
        }];
        if (userReq.value.trim()) {
          inputs[API.DIFY_CONFIG.inputKeys.userRequirementsKey || 'user_requirements'] = userReq.value.trim();
        }

        const result = await API.callDifyWorkflow(apiKey, inputs);
        resultArea.value = Utils.getResultContent(result);
        renderMarkdownPreview();

        Store.setState({
          step3Result: result,
          step3UploadId: uploadId,
          step3FileName: file.name,
          step3UserReq: userReq.value.trim()
        });
      } catch (err) {
        UI.showError(err.message);
      }
    });

    saveBtn.addEventListener('click', () => {
      if (saveBtn.disabled) return;
      Store.setState({
        step3Result: resultArea.value,
        step3UserReq: userReq.value.trim()
      });
      window.location.href = 'step4-write.html';
    });

    nextBtn.addEventListener('click', () => {
      window.location.href = 'step4-write.html';
    });
  </script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>步骤5 - 合规检查</title>
  <link rel="stylesheet" href="../assets/css/shared.css">
  <style>
    #markdownPreview {
      line-height: 1.6;
    }
    #markdownPreview h1 {
      font-size: 2em;
      font-weight: bold;
      margin: 1em 0 0.5em 0;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 0.5em;
    }
    #markdownPreview h2 {
      font-size: 1.5em;
      font-weight: bold;
      margin: 1em 0 0.5em 0;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.3em;
    }
    #markdownPreview h3 {
      font-size: 1.25em;
      font-weight: bold;
      margin: 0.8em 0 0.4em 0;
    }
    #markdownPreview p {
      margin: 0.5em 0;
    }
    #markdownPreview ul, #markdownPreview ol {
      margin: 0.5em 0;
      padding-left: 2em;
    }
    #markdownPreview li {
      margin: 0.3em 0;
    }
    #markdownPreview code {
      background-color: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    #markdownPreview pre {
      background-color: #f3f4f6;
      padding: 1em;
      border-radius: 8px;
      overflow-x: auto;
      margin: 1em 0;
    }
    #markdownPreview pre code {
      background-color: transparent;
      padding: 0;
    }
    #markdownPreview blockquote {
      border-left: 4px solid #3b82f6;
      padding-left: 1em;
      margin: 1em 0;
      color: #6b7280;
    }
    #markdownPreview table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    #markdownPreview table th,
    #markdownPreview table td {
      border: 1px solid #e5e7eb;
      padding: 0.5em;
      text-align: left;
    }
    #markdownPreview table th {
      background-color: #f9fafb;
      font-weight: bold;
    }
    .check-result-content {
      background-color: #f9fafb;
      padding: 1em;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="../index.html" class="text-blue-600 underline text-sm">返回主页</a>
    <h1 class="text-2xl font-bold mb-4">步骤5：合规检查</h1>

    <div class="card space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2">选择类型</label>
        <select id="checkType" class="input">
          <option value="all">全部检查</option>
         </select>
         <div class="text-sm text-gray-500" style="font-size: 12px;">
        包含：<br/>
        章节内合规检查；全局合规检查
        章节内合规检查，包含完整性检查completeness（章节完整性、必备材料完整性）；语言质量检查language（错别字、病句/可读性）；
        风险条款检查risk（模糊承诺、偏离招标条件的措辞、容易被扣分的表述）；<br/>
        全局合规检查，包含一致性检查consistency（金额一致性、工期一致性、人员配置一致性、文本逻辑一致性）；
          </div>
      </div>

      <div id="prevInputContainer">
        <div class="flex items-center justify-between mb-2">
          <label class="block text-sm font-medium"><h2 style="text-align: center;">一、分章节检查结果：</h2></label>
            </div>
        <!-- 动态生成的章节将插入这里 -->
      </div>

      <!-- 全局检查结果显示区域 -->
      <div id="globalCheckResultContainer" class="mt-4" style="display: none;">
        <div class="flex items-center justify-between mb-2">
          <label class="block text-sm font-medium"><h1 style="text-align: center;">二、全局检查结果</h1></label>
        </div>
        <div id="globalCheckResult" class="input p-4 bg-blue-50 border border-blue-200 rounded-lg" style="min-height: 300px; overflow-y: auto;"></div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-2">用户需求（可选）</label>
        <textarea id="userReq" class="input" rows="4" placeholder="补充检查关注点，例如重点检查金额一致性等"></textarea>
      </div>

      <div class="flex space-x-2">
        <button id="selectAllBtn" class="btn btn-secondary">全选</button>
        <button id="prevInputEditBtn" class="btn btn-secondary text-sm">编辑模式</button>
      
        <button id="runBtn" class="btn btn-primary">提交合规检查</button>
      </div>


      <div class="flex space-x-2">
        <button id="saveBtn" class="btn btn-secondary">保存修改并下一步</button>
        <button id="nextBtn" class="btn">直接下一步</button>
      </div>
    </div>
  </div>

  <script src="../assets/js/store.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/ui.js"></script>
  <script src="../assets/js/api.js"></script>
  <!-- Markdown 渲染库 -->
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
  <script>
    const checkType = document.getElementById('checkType');
    const prevInputContainer = document.getElementById('prevInputContainer');
    const prevInputEditBtn = document.getElementById('prevInputEditBtn');
    const userReq = document.getElementById('userReq');
    const runBtn = document.getElementById('runBtn');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const saveBtn = document.getElementById('saveBtn');
    const nextBtn = document.getElementById('nextBtn');

    let currentResultData = null; // 保存当前检查结果

    // 存储章节数据，用于预览/编辑模式切换
    let chapterData = [];
    let isPrevInputEditMode = false;
    // 存储章节检查结果和全局检查结果
    let chapterCheckResults = {}; // { chapterId: { content: "...", summary: "..." } }
    let globalCheckResult = ''; // 全局检查结果（outputs.text）

    // 渲染上一步结果（支持数组格式，每个章节支持预览/编辑模式）
    function renderPrevInput(result) {
      // 保存原始数据
      try {
        let parsedResult = result;
        if (typeof result === 'string') {
          try {
            parsedResult = JSON.parse(result);
          } catch (e) {
            // 不是 JSON，当作普通文本处理
            chapterData = [{ id: '0', title: '章节 1', content: result }];
            renderChapters();
            return;
          }
        }
        
        // 提取章节数据
        if (parsedResult && parsedResult.data && parsedResult.data.outputs && parsedResult.data.outputs.content && Array.isArray(parsedResult.data.outputs.content)) {
          chapterData = parsedResult.data.outputs.content.map((item, index) => ({
            id: item.id || index.toString(),
            title: item.title || `章节 ${index + 1}`,
            content: item.content || ''
          }));
        } else if (parsedResult && parsedResult.content && Array.isArray(parsedResult.content)) {
          chapterData = parsedResult.content.map((item, index) => ({
            id: item.id || index.toString(),
            title: item.title || `章节 ${index + 1}`,
            content: item.content || ''
          }));
        } else {
          // 单个结果
          chapterData = [{ id: '0', title: '章节 1', content: Utils.getResultContent(result) }];
        }
      } catch (e) {
        console.error('渲染上一步结果失败:', e);
        chapterData = [{ id: '0', title: '章节 1', content: Utils.getResultContent(result) }];
      }
      
      renderChapters();
    }

    // 渲染章节（支持预览/编辑模式）
    function renderChapters() {
      // 清空容器（保留标题和编辑按钮）
      const existingChapters = prevInputContainer.querySelectorAll('.chapter-item');
      existingChapters.forEach(el => el.remove());
      
      chapterData.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'chapter-item mb-4 p-4 border border-gray-200 rounded-lg';
        div.dataset.chapterId = item.id;
        
        const header = document.createElement('div');
        header.className = 'flex items-center gap-3 mb-2';
        
        // 选择框
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'w-4 h-4 text-blue-600 rounded focus:ring-blue-500';
        checkbox.checked = true;
        checkbox.dataset.itemId = item.id;
        
        const number = document.createElement('span');
        number.className = 'flex items-center justify-center w-6 h-6 rounded-full bg-blue-500 text-white text-sm font-semibold';
        number.textContent = index + 1;
        
        const label = document.createElement('label');
        label.className = 'text-sm font-medium flex-1';
        label.textContent = item.title;
        
        header.appendChild(checkbox);
        header.appendChild(number);
        header.appendChild(label);
        
        // 预览模式容器
        const previewDiv = document.createElement('div');
        previewDiv.className = 'chapter-preview input p-4';
        previewDiv.style.minHeight = '150px';
        previewDiv.style.overflowY = 'auto';
        if (marked) {
          previewDiv.innerHTML = marked.parse(item.content || '');
        } else {
          previewDiv.textContent = item.content || '';
        }
        
        // 编辑模式容器
        const editDiv = document.createElement('div');
        editDiv.className = 'chapter-edit hidden';
        const textarea = document.createElement('textarea');
        textarea.className = 'input';
        textarea.rows = 10;
        textarea.dataset.itemId = item.id;
        textarea.value = item.content || '';
        editDiv.appendChild(textarea);
        
        // 章节检查结果显示区域（只显示检查摘要）
        const checkResultDiv = document.createElement('div');
        checkResultDiv.className = 'chapter-check-result mt-4 p-4 bg-gray-50 border border-gray-300 rounded-lg';
        checkResultDiv.dataset.chapterId = item.id;
        checkResultDiv.style.display = 'none'; // 默认隐藏，有检查结果时显示
        
        const checkResultTitle = document.createElement('div');
        checkResultTitle.className = 'text-sm font-semibold text-gray-700 mb-2';
        checkResultTitle.textContent = '';
        checkResultDiv.appendChild(checkResultTitle);
        
        const checkResultContent = document.createElement('div');
        checkResultContent.className = 'check-result-content text-sm text-gray-600';
        checkResultDiv.appendChild(checkResultContent);
        
        div.appendChild(header);
        div.appendChild(previewDiv);
        div.appendChild(editDiv);
        div.appendChild(checkResultDiv);
        prevInputContainer.appendChild(div);
        
        // 如果有检查结果，只显示检查摘要（summary）
        if (chapterCheckResults[item.id] && chapterCheckResults[item.id].summary) {
          const result = chapterCheckResults[item.id];
          if (marked) {
            checkResultContent.innerHTML = marked.parse(result.summary);
          } else {
            checkResultContent.textContent = result.summary;
          }
          checkResultDiv.style.display = 'block';
        }
      });
      
      // 根据当前模式显示/隐藏
      updateChapterMode();
    }

    // 更新章节的预览/编辑模式
    function updateChapterMode() {
      const previews = prevInputContainer.querySelectorAll('.chapter-preview');
      const edits = prevInputContainer.querySelectorAll('.chapter-edit');
      
      if (isPrevInputEditMode) {
        previews.forEach(el => el.classList.add('hidden'));
        edits.forEach(el => el.classList.remove('hidden'));
        prevInputEditBtn.textContent = '预览模式';
        // 编辑模式下，启用保存按钮
        saveBtn.disabled = false;
      } else {
        previews.forEach(el => el.classList.remove('hidden'));
        edits.forEach(el => el.classList.add('hidden'));
        prevInputEditBtn.textContent = '编辑模式';
        
        // 更新预览内容
        edits.forEach(editDiv => {
          const textarea = editDiv.querySelector('textarea');
          const chapterId = textarea.dataset.itemId;
          const chapter = chapterData.find(c => c.id === chapterId);
          if (chapter) {
            chapter.content = textarea.value;
            const previewDiv = editDiv.previousElementSibling;
            if (previewDiv && previewDiv.classList.contains('chapter-preview')) {
              if (marked) {
                previewDiv.innerHTML = marked.parse(chapter.content || '');
              } else {
                previewDiv.textContent = chapter.content || '';
              }
            }
          }
        });
        // 预览模式下，禁用保存按钮
        saveBtn.disabled = true;
      }
    }


    // 收集上一步结果内容（只收集被选中的）
    // 返回：始终返回数组的 JSON 字符串，格式为 [{ "id": "...", "title": "...", "content": "..." }]
    function collectPrevInput() {
      // 无论是否在编辑模式，都从 textarea 获取最新内容（如果 textarea 存在）
      const textareas = prevInputContainer.querySelectorAll('.chapter-edit textarea');
      textareas.forEach(textarea => {
        const chapterId = textarea.dataset.itemId;
        const chapter = chapterData.find(c => c.id === chapterId);
        if (chapter) {
          chapter.content = textarea.value;
        }
      });
      
      if (chapterData.length === 0) return '';
      
      // 构建结果数组，只收集被选中的章节
      const resultArray = [];
      chapterData.forEach((item, index) => {
        const chapterDiv = prevInputContainer.querySelector(`[data-chapter-id="${item.id}"]`);
        const checkbox = chapterDiv?.querySelector('input[type="checkbox"]');
        
        // 只收集被选中的内容
        if (!checkbox || checkbox.checked) {
          resultArray.push({
            id: item.id,
            title: item.title,
            content: item.content
          });
        }
      });
      
      // 直接返回数组的 JSON 字符串
      return JSON.stringify(resultArray);
    }


    // 章节编辑按钮事件
    prevInputEditBtn.addEventListener('click', () => {
      isPrevInputEditMode = !isPrevInputEditMode;
      updateChapterMode();
    });

    // 读取状态
    const state = Store.getState();
    if (state.step4Result) {
      renderPrevInput(state.step4Result);
    }
    if (state.step5CheckType) checkType.value = state.step5CheckType;
    if (state.step5UserReq) userReq.value = state.step5UserReq;
    
    // 从缓存中恢复检查结果
    if (state.step5ChapterCheckResults) {
      chapterCheckResults = state.step5ChapterCheckResults;
      // 重新渲染章节以显示检查结果
      renderChapters();
    }
    if (state.step5GlobalCheckResult) {
      globalCheckResult = state.step5GlobalCheckResult;
      // 显示全局检查结果
      const globalContainer = document.getElementById('globalCheckResultContainer');
      const globalResultDiv = document.getElementById('globalCheckResult');
      if (globalContainer && globalResultDiv) {
        if (marked) {
          globalResultDiv.innerHTML = marked.parse(globalCheckResult);
        } else {
          globalResultDiv.textContent = globalCheckResult;
        }
        globalContainer.style.display = 'block';
      }
    }
    
    // 默认预览模式，保存按钮禁用
    saveBtn.disabled = true;

    runBtn.addEventListener('click', async () => {
      try {
        const apiKey = API.DIFY_CONFIG.apiKeys.step5;
        const prevInputContent = collectPrevInput();
        
        // 验证输入：必须是字符串且非空
        if (typeof prevInputContent !== 'string' || !prevInputContent.trim()) {
          UI.showError('请先填写上一步结果（步骤4输出）');
          return;
        }
        
        const inputs = {
          check_type: checkType.value,
          previous_result: prevInputContent, // 始终是字符串类型
        };
        if (userReq.value.trim()) {
          inputs[API.DIFY_CONFIG.inputKeys.userRequirementsKey || 'user_requirements'] = userReq.value.trim();
        }

        // 调用 API 获取完整响应
        const response = await fetch(`${API.DIFY_CONFIG.baseURL}/workflows/run`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            inputs,
            response_mode: 'blocking',
            user: API.DIFY_CONFIG.user,
          }),
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData?.message || errorData?.data?.error || `API调用失败: ${response.status}`);
        }
        
        const responseData = await response.json();
        if (responseData?.data?.error) {
          throw new Error(responseData.data.error);
        }
        
        // 接口返回的结果处理
        // 1. 提取 outputs.output 数组中的章节检查结果
        // 2. 提取 outputs.text 作为全局检查结果
        try {
          // 提取章节检查结果（outputs.output）
          if (responseData?.data?.outputs?.output && Array.isArray(responseData.data.outputs.output)) {
            // 清空之前的检查结果
            chapterCheckResults = {};
            
            // 将检查结果按 id 匹配到对应章节
            responseData.data.outputs.output.forEach((item) => {
              if (item.id) {
                chapterCheckResults[item.id] = {
                  content: item.content || '',
                  summary: item.summary || ''
                };
              }
            });
            
            // 保存到缓存
            Store.setState({
              step5ChapterCheckResults: chapterCheckResults
            });
          }
          
          // 提取全局检查结果（outputs.text）
          if (responseData?.data?.outputs?.text) {
            globalCheckResult = responseData.data.outputs.text;
          } else if (responseData?.data?.outputs?.content && typeof responseData.data.outputs.content === 'string') {
            globalCheckResult = responseData.data.outputs.content;
          }
          
          // 保存全局检查结果到缓存
          if (globalCheckResult) {
            Store.setState({
              step5GlobalCheckResult: globalCheckResult
            });
          }
          
          // 重新渲染章节，显示检查结果
          renderChapters();
          
          // 显示全局检查结果
          if (globalCheckResult) {
            const globalContainer = document.getElementById('globalCheckResultContainer');
            const globalResultDiv = document.getElementById('globalCheckResult');
            if (globalContainer && globalResultDiv) {
              if (marked) {
                globalResultDiv.innerHTML = marked.parse(globalCheckResult);
              } else {
                globalResultDiv.textContent = globalCheckResult;
              }
              globalContainer.style.display = 'block';
            }
          }
          
          // 如果接口返回了章节内容更新，也处理一下（保持原有逻辑）
          let updatedChapters = [];
          if (responseData?.data?.outputs?.content && Array.isArray(responseData.data.outputs.content)) {
            updatedChapters = responseData.data.outputs.content;
          } else if (responseData?.content && Array.isArray(responseData.content)) {
            updatedChapters = responseData.content;
          }
          
          // 如果有章节内容更新，覆盖章节内容
          if (updatedChapters.length > 0 && updatedChapters.length === chapterData.length) {
            chapterData = chapterData.map((originalChapter, index) => {
              const updatedChapter = updatedChapters[index];
              return {
                ...originalChapter,
                content: updatedChapter.content || updatedChapter.text || originalChapter.content
              };
            });
            renderChapters();
          }
        } catch (e) {
          console.error('处理检查结果失败:', e);
          UI.showError('处理检查结果失败: ' + e.message);
        }
        
        // 保存完整响应数据
        const result = responseData;
        Store.setState({
          step5Result: result,
          step5CheckType: checkType.value,
          step5UserReq: userReq.value.trim(),
        });
      } catch (err) {
        UI.showError(err.message);
      }
    });

    // 全选/取消全选功能
    let isAllSelected = true;
    selectAllBtn.addEventListener('click', () => {
      // 获取所有 checkbox（章节选择框）
      const allCheckboxes = prevInputContainer.querySelectorAll('input[type="checkbox"]');
      
      if (allCheckboxes.length === 0) return;
      
      // 切换所有 checkbox 的状态
      isAllSelected = !isAllSelected;
      allCheckboxes.forEach(checkbox => {
        checkbox.checked = isAllSelected;
      });
      
      // 更新按钮文本
      selectAllBtn.textContent = isAllSelected ? '全选' : '取消全选';
    });

    // 收集所有步骤内容并合并为 Markdown 格式
    function collectAllContentAsMarkdown() {
      const state = Store.getState();
      let markdown = '# 标书文档\n\n';
      
      // 步骤1：解析招标文件
      if (state.step1Result) {
        markdown += '## 一、招标文件解析结果\n\n';
        markdown += Utils.getResultContent(state.step1Result) + '\n\n';
      }
      
      // 步骤2：标书大纲
      if (state.step2Result) {
        markdown += '## 二、标书大纲\n\n';
        markdown += Utils.getResultContent(state.step2Result) + '\n\n';
      }
      
      // 步骤3：公司资料
      if (state.step3Result) {
        markdown += '## 三、公司资料\n\n';
        markdown += Utils.getResultContent(state.step3Result) + '\n\n';
      }
      
      // 步骤4：标书内容
      if (state.step4Result) {
        markdown += '## 四、标书内容\n\n';
        try {
          const step4Data = typeof state.step4Result === 'string' ? JSON.parse(state.step4Result) : state.step4Result;
          if (step4Data && step4Data.data && step4Data.data.outputs && step4Data.data.outputs.content && Array.isArray(step4Data.data.outputs.content)) {
            step4Data.data.outputs.content.forEach((item, index) => {
              markdown += `### ${item.title || `章节 ${index + 1}`}\n\n`;
              markdown += item.content + '\n\n';
            });
          } else if (step4Data && step4Data.content && Array.isArray(step4Data.content)) {
            step4Data.content.forEach((item, index) => {
              markdown += `### ${item.title || `章节 ${index + 1}`}\n\n`;
              markdown += item.content + '\n\n';
            });
          } else {
            markdown += Utils.getResultContent(state.step4Result) + '\n\n';
          }
        } catch (e) {
          markdown += Utils.getResultContent(state.step4Result) + '\n\n';
        }
      }
      
      // 步骤5：合规检查结果
      if (state.step5Result) {
        markdown += '## 五、合规检查结果\n\n';
        try {
          const step5Data = typeof state.step5Result === 'string' ? JSON.parse(state.step5Result) : state.step5Result;
          if (step5Data && step5Data.data && step5Data.data.outputs && step5Data.data.outputs.content && Array.isArray(step5Data.data.outputs.content)) {
            step5Data.data.outputs.content.forEach((item, index) => {
              markdown += `### ${item.title || `检查项 ${index + 1}`}\n\n`;
              markdown += item.content + '\n\n';
            });
          } else if (step5Data && step5Data.content && Array.isArray(step5Data.content)) {
            step5Data.content.forEach((item, index) => {
              markdown += `### ${item.title || `检查项 ${index + 1}`}\n\n`;
              markdown += item.content + '\n\n';
            });
          } else {
            markdown += Utils.getResultContent(state.step5Result) + '\n\n';
          }
        } catch (e) {
          markdown += Utils.getResultContent(state.step5Result) + '\n\n';
        }
      }
      
      return markdown;
    }

    saveBtn.addEventListener('click', () => {
      // 保存当前状态
      Store.setState({
        step5CheckType: checkType.value,
        step5UserReq: userReq.value.trim(),
      });
      window.location.href = 'step6-merge.html';
    });

    nextBtn.addEventListener('click', () => {
      window.location.href = 'step6-merge.html';
    });
  </script>
</body>
</html>


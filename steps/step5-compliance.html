<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>步骤5 - 合规检查</title>
  <link rel="stylesheet" href="../assets/css/shared.css">
  <style>
    #markdownPreview {
      line-height: 1.6;
    }
    #markdownPreview h1 {
      font-size: 2em;
      font-weight: bold;
      margin: 1em 0 0.5em 0;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 0.5em;
    }
    #markdownPreview h2 {
      font-size: 1.5em;
      font-weight: bold;
      margin: 1em 0 0.5em 0;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.3em;
    }
    #markdownPreview h3 {
      font-size: 1.25em;
      font-weight: bold;
      margin: 0.8em 0 0.4em 0;
    }
    #markdownPreview p {
      margin: 0.5em 0;
    }
    #markdownPreview ul, #markdownPreview ol {
      margin: 0.5em 0;
      padding-left: 2em;
    }
    #markdownPreview li {
      margin: 0.3em 0;
    }
    #markdownPreview code {
      background-color: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    #markdownPreview pre {
      background-color: #f3f4f6;
      padding: 1em;
      border-radius: 8px;
      overflow-x: auto;
      margin: 1em 0;
    }
    #markdownPreview pre code {
      background-color: transparent;
      padding: 0;
    }
    #markdownPreview blockquote {
      border-left: 4px solid #3b82f6;
      padding-left: 1em;
      margin: 1em 0;
      color: #6b7280;
    }
    #markdownPreview table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    #markdownPreview table th,
    #markdownPreview table td {
      border: 1px solid #e5e7eb;
      padding: 0.5em;
      text-align: left;
    }
    #markdownPreview table th {
      background-color: #f9fafb;
      font-weight: bold;
    }
    .check-result-content {
      background-color: #f9fafb;
      padding: 1em;
      border-radius: 8px;
    }
    /* 吸底工具栏样式 */
    .bottom-toolbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      padding: 1rem;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: flex;
      justify-content: center;
    }
    .bottom-toolbar .toolbar-content {
      max-width: 1200px;
      width: 100%;
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    /* 给内容区域添加底部padding，避免被工具栏遮挡 */
    body .container {
      padding-bottom: 80px !important;
    }
    /* 标签页样式 */
    .tabs-container {
      margin-top: 1.5rem;
    }
    .tabs-header {
      display: flex;
      border-bottom: 2px solid #e5e7eb;
      margin-bottom: 1rem;
    }
    .tab-button {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      color: #6b7280;
      transition: all 0.3s ease;
      position: relative;
      bottom: -2px;
    }
    .tab-button:hover {
      color: #2563eb;
      background-color: #f9fafb;
    }
    .tab-button.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
      font-weight: 600;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .section-header {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e5e7eb;
    }
    /* 章节检查结果区域优化 - 使用原生滚动条 */
    #prevInputContainer {
      max-height: 70vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    /* 左右分栏布局 */
    .chapter-split-view {
      display: none;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
    }
    .chapter-split-view.active {
      display: grid;
    }
    .chapter-original-content,
    .chapter-check-result-full {
      padding: 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background-color: #f9fafb;
      max-height: 60vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .chapter-original-content {
      background-color: #ffffff;
    }
    .chapter-check-result-full {
      background-color: #f0f9ff;
    }
    .split-view-header {
      font-weight: 600;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
    }
    /* 全局检查结果区域优化 - 使用原生滚动条 */
    #globalCheckResultContainer {
      max-height: 70vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    /* 确保使用原生滚动条样式，不自定义 */
    #prevInputContainer::-webkit-scrollbar,
    #globalCheckResultContainer::-webkit-scrollbar {
      width: auto;
      height: auto;
    }
    .space-y-2 a{
      text-decoration: none;margin-right: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="../index.html" class="text-blue-600 underline text-sm">返回主页</a>
    <h1 class="text-2xl font-bold mb-4">步骤5：合规检查</h1>

    <div class="card space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2">选择类型</label>
        <select id="checkType" class="input">
          <option value="all">全部检查</option>
         </select>
         <div class="text-sm text-gray-500" style="font-size: 12px;">
        包含：<br/>
        章节内合规检查；全局合规检查
        章节内合规检查，包含完整性检查completeness（章节完整性、必备材料完整性）；语言质量检查language（错别字、病句/可读性）；
        风险条款检查risk（模糊承诺、偏离招标条件的措辞、容易被扣分的表述）；<br/>
        全局合规检查，包含一致性检查consistency（金额一致性、工期一致性、人员配置一致性、文本逻辑一致性）；
        <p>&nbsp;</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">用户需求（可选）</label>
            <textarea id="userReq" class="input" rows="4" placeholder="补充检查关注点，例如重点检查金额一致性等"></textarea>
          </div>
          <button id="runBtn" class="btn btn-primary">提交</button>
      </div>

      <!-- 检查结果标签页容器 -->
      <div class="tabs-container">
        <div class="tabs-header">
          <button id="chapterTabBtn" class="tab-button active" onclick="switchTab('chapter')">
            章节结果
          </button>
          <button id="globalTabBtn" class="tab-button" onclick="switchTab('global')" style="display: none;">
            整体结果
          </button>
        </div>

        <!-- 分章节检查结果标签页 -->
        <div id="chapterTabContent" class="tab-content active">
          <!-- 章节目录索引 -->
          <div id="chapterIndex" class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
            <div class="text-sm font-semibold text-gray-700 mb-2">章节目录</div>
            <div id="chapterIndexList" class="space-y-2">
              <!-- 目录项将动态生成 -->
            </div>
          </div>
          
          <div id="prevInputContainer">
            <!-- 动态生成的章节将插入这里 -->
          </div>
        </div>

        <!-- 全局检查结果标签页 -->
        <div id="globalTabContent" class="tab-content">
          <div id="globalCheckResultContainer">
            <div id="globalCheckResult" class="input p-4 bg-blue-50 border border-blue-200 rounded-lg" style="min-height: 300px; cursor: default;" readonly></div>
          </div>
        </div>
      </div>

    

     
    </div>
  </div>
  
  <!-- 吸底工具栏 -->
  <div class="bottom-toolbar">
    <div class="flex space-x-2">
      
      <button id="prevInputEditBtn" class="btn btn-secondary text-sm">编辑模式</button>
      
    </div>
    <div class="toolbar-content">
      <button id="saveBtn" class="btn btn-secondary">保存修改并下一步</button>
      <button id="nextBtn" class="btn">直接下一步</button>
    </div>
  </div>

  <script src="../assets/js/store.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/ui.js"></script>
  <script src="../assets/js/api.js"></script>
  <!-- Markdown 渲染库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  <script>
    const checkType = document.getElementById('checkType');
    const prevInputContainer = document.getElementById('prevInputContainer');
    const prevInputEditBtn = document.getElementById('prevInputEditBtn');
    const userReq = document.getElementById('userReq');
    const runBtn = document.getElementById('runBtn');
    const selectAllBtn = document.getElementById('selectAllBtn'); // 可能不存在，需要检查
    const saveBtn = document.getElementById('saveBtn');
    const nextBtn = document.getElementById('nextBtn');

    let currentResultData = null; // 保存当前检查结果

    // 存储章节数据，用于预览/编辑模式切换
    let chapterData = [];
    let isPrevInputEditMode = false;
    // 存储章节检查结果和全局检查结果
    let chapterCheckResults = {}; // { chapterId: { content: "...", summary: "..." } }
    let globalCheckResult = ''; // 全局检查结果（outputs.text）

    // 渲染上一步结果（支持数组格式，每个章节支持预览/编辑模式）
    function renderPrevInput(result) {
      // 保存原始数据
      try {
        let parsedResult = result;
        if (typeof result === 'string') {
          try {
            parsedResult = JSON.parse(result);
          } catch (e) {
            // 不是 JSON，当作普通文本处理
            chapterData = [{ id: '0', title: '章节 1', content: result }];
            renderChapters();
            return;
          }
        }
        
        // 提取章节数据
        if (parsedResult && parsedResult.data && parsedResult.data.outputs && parsedResult.data.outputs.content && Array.isArray(parsedResult.data.outputs.content)) {
          chapterData = parsedResult.data.outputs.content.map((item, index) => ({
            id: item.id || index.toString(),
            title: item.title || `章节 ${index + 1}`,
            content: item.content || ''
          }));
        } else if (parsedResult && parsedResult.content && Array.isArray(parsedResult.content)) {
          chapterData = parsedResult.content.map((item, index) => ({
            id: item.id || index.toString(),
            title: item.title || `章节 ${index + 1}`,
            content: item.content || ''
          }));
        } else {
          // 单个结果
          chapterData = [{ id: '0', title: '章节 1', content: Utils.getResultContent(result) }];
        }
      } catch (e) {
        console.error('渲染上一步结果失败:', e);
        chapterData = [{ id: '0', title: '章节 1', content: Utils.getResultContent(result) }];
      }
      
      renderChapters();
    }

    // 渲染章节目录索引
    function renderChapterIndex() {
      const chapterIndexList = document.getElementById('chapterIndexList');
      if (!chapterIndexList) return;
      
      // 清空目录
      chapterIndexList.innerHTML = '';
      
      // 生成目录项
      chapterData.forEach((item, index) => {
        const indexItem = document.createElement('a');
        indexItem.href = `#chapter-${item.id}`;
        indexItem.className = 'block px-3 py-2 text-sm bg-white border border-gray-300 rounded hover:bg-blue-50 hover:border-blue-400 text-gray-700 hover:text-blue-600 transition-colors';
        indexItem.textContent = `${item.title}`;
        indexItem.onclick = (e) => {
          e.preventDefault();
          const targetElement = document.getElementById(`chapter-${item.id}`);
          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        };
        chapterIndexList.appendChild(indexItem);
      });
    }

    // 渲染章节（支持预览/编辑模式）
    function renderChapters() {
      // 先渲染目录索引
      renderChapterIndex();
      
      // 清空容器（保留标题和编辑按钮）
      const existingChapters = prevInputContainer.querySelectorAll('.chapter-item');
      existingChapters.forEach(el => el.remove());
      
      chapterData.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'chapter-item mb-4 p-4 border border-gray-200 rounded-lg';
        div.id = `chapter-${item.id}`; // 添加锚点ID
        div.dataset.chapterId = item.id;
        
        const header = document.createElement('div');
        header.className = 'flex items-center gap-3 mb-2';
        
        // 选择框
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'w-4 h-4 text-blue-600 rounded focus:ring-blue-500';
        checkbox.checked = true;
        checkbox.dataset.itemId = item.id;
        
        const number = document.createElement('span');
        number.className = 'flex items-center justify-center w-6 h-6 rounded-full bg-blue-500 text-white text-sm font-semibold';
        number.textContent = index + 1;
        
        const label = document.createElement('label');
        label.className = 'text-sm font-medium flex-1';
        label.textContent = item.title;
        
        // 查看原文按钮
        const viewOriginalBtn = document.createElement('button');
        viewOriginalBtn.type = 'button';
        viewOriginalBtn.className = 'btn btn-secondary text-xs px-3 py-1 ml-auto';
        viewOriginalBtn.textContent = '查看章节原文';
        viewOriginalBtn.dataset.chapterId = item.id;
        viewOriginalBtn.onclick = () => toggleOriginalView(item.id);
        
        header.appendChild(checkbox);
        header.appendChild(number);
        header.appendChild(label);
        header.appendChild(viewOriginalBtn);
        
        // 章节原文（默认隐藏，点击查看原文按钮后显示，Markdown格式渲染）
        const originalDiv = document.createElement('div');
        originalDiv.className = 'chapter-original mt-4 p-4 bg-white border border-gray-200 rounded-lg hidden';
        originalDiv.dataset.chapterId = item.id;
        
        const originalContent = document.createElement('div');
        originalContent.className = 'chapter-original-content';
        if (marked) {
          originalContent.innerHTML = marked.parse(item.content || '');
        } else {
          originalContent.textContent = item.content || '';
        }
        originalDiv.appendChild(originalContent);
        
        // 编辑模式容器
        const editDiv = document.createElement('div');
        editDiv.className = 'chapter-edit hidden';
        const textarea = document.createElement('textarea');
        textarea.className = 'input';
        textarea.rows = 10;
        textarea.dataset.itemId = item.id;
        textarea.value = item.content || '';
        editDiv.appendChild(textarea);
        
        // 章节检查结果显示区域（在原文下方显示）
        const checkResultDiv = document.createElement('div');
        checkResultDiv.className = 'chapter-check-result mt-4 p-4 bg-gray-50 border border-gray-300 rounded-lg';
        checkResultDiv.dataset.chapterId = item.id;
        
        const checkResultTitle = document.createElement('div');
        checkResultTitle.className = 'text-sm font-semibold text-gray-700 mb-2';
        checkResultTitle.textContent = '=====章节检查内容=====';
        checkResultDiv.appendChild(checkResultTitle);
        
        const checkResultContent = document.createElement('div');
        checkResultContent.className = 'check-result-content text-sm text-gray-600';
        checkResultDiv.appendChild(checkResultContent);
        
        div.appendChild(header);
        div.appendChild(originalDiv);
        div.appendChild(editDiv);
        div.appendChild(checkResultDiv);
        prevInputContainer.appendChild(div);
        
        // 如果有检查结果，显示检查结果（优先显示完整内容content，如果没有则显示摘要summary）
        if (chapterCheckResults[item.id]) {
          const result = chapterCheckResults[item.id];
          // 优先显示完整检查结果（content），如果没有则显示摘要（summary）
          const displayContent = result.content || result.summary || '';
          if (displayContent) {
            if (marked) {
              checkResultContent.innerHTML = marked.parse(displayContent);
            } else {
              checkResultContent.textContent = displayContent;
            }
          } else {
            checkResultDiv.style.display = 'none';
          }
        } else {
          // 如果没有检查结果，隐藏检查结果区域
          checkResultDiv.style.display = 'none';
        }
      });
      
      // 根据当前模式显示/隐藏
      updateChapterMode();
    }

    // 切换显示/隐藏章节原文
    function toggleOriginalView(chapterId) {
      const chapterDiv = prevInputContainer.querySelector(`[data-chapter-id="${chapterId}"]`);
      if (!chapterDiv) return;
      
      const originalDiv = chapterDiv.querySelector('.chapter-original');
      const viewOriginalBtn = chapterDiv.querySelector('button[data-chapter-id]');
      
      if (!originalDiv || !viewOriginalBtn) return;
      
      if (originalDiv.classList.contains('hidden')) {
        // 显示章节原文
        originalDiv.classList.remove('hidden');
        viewOriginalBtn.textContent = '收起原文';
      } else {
        // 隐藏章节原文
        originalDiv.classList.add('hidden');
        viewOriginalBtn.textContent = '查看章节原文';
      }
    }

    // 更新章节的预览/编辑模式
    function updateChapterMode() {
      // 注意：原文的显示/隐藏由"查看章节原文"按钮控制，不在这里处理
      const edits = prevInputContainer.querySelectorAll('.chapter-edit');
      
      if (isPrevInputEditMode) {
        // 编辑模式：显示编辑框（原文的显示状态保持不变）
        edits.forEach(el => el.classList.remove('hidden'));
        prevInputEditBtn.textContent = '预览模式';
        // 编辑模式下，启用保存按钮
        saveBtn.disabled = false;
      } else {
        // 预览模式：隐藏编辑框，同步编辑内容到原文显示区域（如果原文已显示）
        edits.forEach(el => el.classList.add('hidden'));
        prevInputEditBtn.textContent = '编辑模式';
        
        // 更新原文内容（从编辑框同步到原文显示区域，仅在原文已显示时更新）
        edits.forEach(editDiv => {
          const textarea = editDiv.querySelector('textarea');
          const chapterId = textarea.dataset.itemId;
          const chapter = chapterData.find(c => c.id === chapterId);
          if (chapter) {
            chapter.content = textarea.value;
            // 找到对应的原文显示区域并更新（如果原文当前是显示的）
            const chapterDiv = prevInputContainer.querySelector(`[data-chapter-id="${chapterId}"]`);
            if (chapterDiv) {
              const originalDiv = chapterDiv.querySelector('.chapter-original');
              if (originalDiv && !originalDiv.classList.contains('hidden')) {
                const originalContent = chapterDiv.querySelector('.chapter-original-content');
                if (originalContent) {
                  if (marked) {
                    originalContent.innerHTML = marked.parse(chapter.content || '');
                  } else {
                    originalContent.textContent = chapter.content || '';
                  }
                }
              }
            }
          }
        });
        // 预览模式下，禁用保存按钮
        saveBtn.disabled = true;
      }
    }


    // 收集上一步结果内容（默认收集全部章节，不考虑checkbox选中状态）
    // 返回：JSON 字符串，格式为 "[{\"id\":\"...\",\"title\":\"...\",\"content\":\"...\"}, ...]"
    function collectPrevInput() {
      // 无论是否在编辑模式，都从 textarea 获取最新内容（如果 textarea 存在）
      const textareas = prevInputContainer.querySelectorAll('.chapter-edit textarea');
      textareas.forEach(textarea => {
        const chapterId = textarea.dataset.itemId;
        const chapter = chapterData.find(c => c.id === chapterId);
        if (chapter) {
          chapter.content = textarea.value;
        }
      });
      
      if (chapterData.length === 0) return '';
      
      // 构建结果数组，收集所有章节（默认全部检查，不考虑checkbox状态）
      const resultArray = chapterData.map((item, index) => ({
        id: item.id || `batch-${index + 1}`,
        title: item.title || `章节 ${index + 1}`,
        content: item.content || ''
      }));
      
      // 返回 JSON 字符串，确保所有章节都被包含
      const jsonString = JSON.stringify(resultArray);
      console.log(`[收集章节] 共收集 ${resultArray.length} 个章节:`, resultArray.map(c => c.title || c.id));
      console.log(`[收集章节] JSON 字符串长度:`, jsonString.length);
      return jsonString;
    }


    // 章节编辑按钮事件
    prevInputEditBtn.addEventListener('click', () => {
      isPrevInputEditMode = !isPrevInputEditMode;
      updateChapterMode();
    });

    // 读取状态
    const state = Store.getState();
    if (state.step4Result) {
      renderPrevInput(state.step4Result);
    }
    if (state.step5CheckType) checkType.value = state.step5CheckType;
    if (state.step5UserReq) userReq.value = state.step5UserReq;
    
    // 从缓存中恢复检查结果
    if (state.step5ChapterCheckResults) {
      chapterCheckResults = state.step5ChapterCheckResults;
      // 重新渲染章节以显示检查结果
      renderChapters();
    }
    if (state.step5GlobalCheckResult) {
      globalCheckResult = state.step5GlobalCheckResult;
      // 显示全局检查结果
      const globalResultDiv = document.getElementById('globalCheckResult');
      if (globalResultDiv) {
        if (marked) {
          globalResultDiv.innerHTML = marked.parse(globalCheckResult);
        } else {
          globalResultDiv.textContent = globalCheckResult;
        }
        // 如果全局检查结果存在，启用全局检查结果标签页
        const globalTabBtn = document.getElementById('globalTabBtn');
        if (globalTabBtn) {
          globalTabBtn.style.display = 'block';
        }
      }
    }
    
    // 标签页切换函数
    function switchTab(tabName) {
      const chapterTabBtn = document.getElementById('chapterTabBtn');
      const globalTabBtn = document.getElementById('globalTabBtn');
      const chapterTabContent = document.getElementById('chapterTabContent');
      const globalTabContent = document.getElementById('globalTabContent');
      
      if (tabName === 'chapter') {
        chapterTabBtn.classList.add('active');
        globalTabBtn.classList.remove('active');
        chapterTabContent.classList.add('active');
        globalTabContent.classList.remove('active');
        
        // 切换到分章节检查结果时，启用编辑模式按钮
        if (prevInputEditBtn) {
          prevInputEditBtn.disabled = false;
          prevInputEditBtn.style.opacity = '1';
        }
      } else if (tabName === 'global') {
        chapterTabBtn.classList.remove('active');
        globalTabBtn.classList.add('active');
        chapterTabContent.classList.remove('active');
        globalTabContent.classList.add('active');
        
        // 切换到全局检查结果时，禁用编辑模式按钮（编辑模式仅限分章节检查）
        if (prevInputEditBtn) {
          prevInputEditBtn.disabled = true;
          prevInputEditBtn.style.opacity = '0.5';
          // 如果当前是编辑模式，切换回预览模式
          if (isPrevInputEditMode) {
            isPrevInputEditMode = false;
            updateChapterMode();
          }
        }
      }
    }
    
    // 将函数暴露到全局作用域
    window.switchTab = switchTab;
    
    // 默认预览模式，保存按钮禁用
    saveBtn.disabled = true;
    
    // 初始化时，编辑模式按钮启用（因为默认显示分章节检查结果标签页）
    if (prevInputEditBtn) {
      prevInputEditBtn.disabled = false;
      prevInputEditBtn.style.opacity = '1';
    }

    runBtn.addEventListener('click', async () => {
      try {
        const apiKey = API.DIFY_CONFIG.apiKeys.step5;
        
        // 收集所有章节内容（默认全部检查，不考虑checkbox状态）
        const prevInputContent = collectPrevInput();
        
        // 验证输入：必须是 JSON 字符串且非空
        if (typeof prevInputContent !== 'string' || !prevInputContent.trim()) {
          UI.showError('请先填写上一步结果（步骤4输出）');
          return;
        }
        
        // 验证提交的章节数量
        try {
          const submittedChapters = JSON.parse(prevInputContent);
          console.log(`[提交检查] 准备检查 ${submittedChapters.length} 个章节:`, submittedChapters.map(c => c.title || c.id));
          if (submittedChapters.length === 0) {
            UI.showError('没有可检查的章节，请确保至少有一个章节');
            return;
          }
          // 打印前100个字符预览
          console.log(`[提交检查] JSON 字符串预览:`, prevInputContent.substring(0, 100) + '...');
        } catch (e) {
          console.error('无法解析提交的章节数据:', e);
          UI.showError('章节数据格式错误，请重试');
          return;
        }
        
        // 禁用按钮，显示加载状态
        runBtn.disabled = true;
        runBtn.textContent = '处理中...';
        
        // 传递 JSON 字符串给 Dify API（与之前格式一致）
        const inputs = {
          check_type: checkType.value,
          previous_result: prevInputContent, // JSON 字符串格式: "[{\"id\":\"...\",\"title\":\"...\",\"content\":\"...\"}, ...]"
        };
        if (userReq.value.trim()) {
          inputs[API.DIFY_CONFIG.inputKeys.userRequirementsKey || 'user_requirements'] = userReq.value.trim();
        }
        
        console.log(`[提交检查] 最终 inputs.previous_result 类型:`, typeof inputs.previous_result);
        console.log(`[提交检查] 最终 inputs.previous_result 长度:`, inputs.previous_result.length);
        console.log(`[提交检查] 完整的 inputs 对象:`, JSON.stringify(inputs, null, 2));
        console.log(`[提交检查] 完整的请求 body:`, JSON.stringify({
          inputs,
          response_mode: 'blocking',
          user: API.DIFY_CONFIG.user,
        }, null, 2));

        // 调用 API 获取完整响应
        const response = await fetch(`${API.DIFY_CONFIG.baseURL}/workflows/run`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            inputs,
            response_mode: 'blocking',
            user: API.DIFY_CONFIG.user,
          }),
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData?.message || errorData?.data?.error || `API调用失败: ${response.status}`);
        }
        
        const responseData = await response.json();
        if (responseData?.data?.error) {
          throw new Error(responseData.data.error);
        }
        
        // 打印完整的响应数据结构，用于调试
        console.log(`[API响应] 完整响应数据:`, JSON.stringify(responseData, null, 2));
        console.log(`[API响应] outputs 结构:`, responseData?.data?.outputs);
        console.log(`[API响应] outputs.output 类型:`, typeof responseData?.data?.outputs?.output);
        console.log(`[API响应] outputs.output 是否为数组:`, Array.isArray(responseData?.data?.outputs?.output));
        if (responseData?.data?.outputs?.output) {
          console.log(`[API响应] outputs.output 长度:`, responseData.data.outputs.output.length);
          console.log(`[API响应] outputs.output 内容:`, responseData.data.outputs.output);
        }
        
        // 接口返回的结果处理
        // 1. 提取 outputs.output 数组中的章节检查结果
        // 2. 提取 outputs.text 作为全局检查结果
        try {
          // 提取章节检查结果（outputs.output）
          if (responseData?.data?.outputs?.output && Array.isArray(responseData.data.outputs.output)) {
            console.log(`[处理结果] 找到 ${responseData.data.outputs.output.length} 个章节检查结果`);
            // 清空之前的检查结果
            chapterCheckResults = {};
            
            // 将检查结果按 id 匹配到对应章节
            responseData.data.outputs.output.forEach((item, index) => {
              console.log(`[处理结果] 章节 ${index + 1}:`, {
                id: item.id,
                hasContent: !!item.content,
                hasSummary: !!item.summary,
                contentLength: item.content?.length || 0
              });
              if (item.id) {
                chapterCheckResults[item.id] = {
                  content: item.content || '',
                  summary: item.summary || ''
                };
              } else {
                console.warn(`[处理结果] 警告：章节 ${index + 1} 没有 id 字段:`, item);
              }
            });
            
            console.log(`[处理结果] 最终 chapterCheckResults 数量:`, Object.keys(chapterCheckResults).length);
            
            // 保存到缓存
            Store.setState({
              step5ChapterCheckResults: chapterCheckResults
            });
          }
          
          // 提取全局检查结果（outputs.text）
          if (responseData?.data?.outputs?.text) {
            globalCheckResult = responseData.data.outputs.text;
          } else if (responseData?.data?.outputs?.content && typeof responseData.data.outputs.content === 'string') {
            globalCheckResult = responseData.data.outputs.content;
          }
          
          // 保存全局检查结果到缓存
          if (globalCheckResult) {
            Store.setState({
              step5GlobalCheckResult: globalCheckResult
            });
          }
          
          // 重新渲染章节，显示检查结果
          renderChapters();
          
          // 显示全局检查结果
          if (globalCheckResult) {
            const globalResultDiv = document.getElementById('globalCheckResult');
            if (globalResultDiv) {
              if (marked) {
                globalResultDiv.innerHTML = marked.parse(globalCheckResult);
              } else {
                globalResultDiv.textContent = globalCheckResult;
              }
              // 如果全局检查结果存在，显示并启用全局检查结果标签页
              const globalTabBtn = document.getElementById('globalTabBtn');
              if (globalTabBtn) {
                globalTabBtn.style.display = 'block';
              }
            }
          }
          
          // 如果接口返回了章节内容更新，也处理一下（保持原有逻辑）
          let updatedChapters = [];
          if (responseData?.data?.outputs?.content && Array.isArray(responseData.data.outputs.content)) {
            updatedChapters = responseData.data.outputs.content;
          } else if (responseData?.content && Array.isArray(responseData.content)) {
            updatedChapters = responseData.content;
          }
          
          // 如果有章节内容更新，覆盖章节内容
          if (updatedChapters.length > 0 && updatedChapters.length === chapterData.length) {
            chapterData = chapterData.map((originalChapter, index) => {
              const updatedChapter = updatedChapters[index];
              return {
                ...originalChapter,
                content: updatedChapter.content || updatedChapter.text || originalChapter.content
              };
            });
            renderChapters();
          }
        } catch (e) {
          console.error('处理检查结果失败:', e);
          UI.showError('处理检查结果失败: ' + e.message);
        }
        
        // 保存完整响应数据
        const result = responseData;
        Store.setState({
          step5Result: result,
          step5CheckType: checkType.value,
          step5UserReq: userReq.value.trim(),
        });
        
        // 恢复按钮状态
        runBtn.disabled = false;
        runBtn.textContent = '提交';
      } catch (err) {
        // 出错时也要恢复按钮状态
        runBtn.disabled = false;
        runBtn.textContent = '提交';
        UI.showError(err.message);
      }
    });

    // 全选/取消全选功能（如果按钮存在）
    if (selectAllBtn) {
      let isAllSelected = true;
      selectAllBtn.addEventListener('click', () => {
        // 获取所有 checkbox（章节选择框）
        const allCheckboxes = prevInputContainer.querySelectorAll('input[type="checkbox"]');
        
        if (allCheckboxes.length === 0) return;
        
        // 切换所有 checkbox 的状态
        isAllSelected = !isAllSelected;
        allCheckboxes.forEach(checkbox => {
          checkbox.checked = isAllSelected;
        });
        
        // 更新按钮文本
        selectAllBtn.textContent = isAllSelected ? '全选' : '取消全选';
      });
    }

    // 收集所有步骤内容并合并为 Markdown 格式
    function collectAllContentAsMarkdown() {
      const state = Store.getState();
      let markdown = '# 标书文档\n\n';
      
      // 步骤1：解析招标文件
      if (state.step1Result) {
        markdown += '## 一、招标文件解析结果\n\n';
        markdown += Utils.getResultContent(state.step1Result) + '\n\n';
      }
      
      // 步骤2：标书大纲
      if (state.step2Result) {
        markdown += '## 二、标书大纲\n\n';
        markdown += Utils.getResultContent(state.step2Result) + '\n\n';
      }
      
      // 步骤3：公司资料
      if (state.step3Result) {
        markdown += '## 三、公司资料\n\n';
        markdown += Utils.getResultContent(state.step3Result) + '\n\n';
      }
      
      // 步骤4：标书内容
      if (state.step4Result) {
        markdown += '## 四、标书内容\n\n';
        try {
          const step4Data = typeof state.step4Result === 'string' ? JSON.parse(state.step4Result) : state.step4Result;
          if (step4Data && step4Data.data && step4Data.data.outputs && step4Data.data.outputs.content && Array.isArray(step4Data.data.outputs.content)) {
            step4Data.data.outputs.content.forEach((item, index) => {
              markdown += `### ${item.title || `章节 ${index + 1}`}\n\n`;
              markdown += item.content + '\n\n';
            });
          } else if (step4Data && step4Data.content && Array.isArray(step4Data.content)) {
            step4Data.content.forEach((item, index) => {
              markdown += `### ${item.title || `章节 ${index + 1}`}\n\n`;
              markdown += item.content + '\n\n';
            });
          } else {
            markdown += Utils.getResultContent(state.step4Result) + '\n\n';
          }
        } catch (e) {
          markdown += Utils.getResultContent(state.step4Result) + '\n\n';
        }
      }
      
      // 步骤5：合规检查结果
      if (state.step5Result) {
        markdown += '## 五、合规检查结果\n\n';
        try {
          const step5Data = typeof state.step5Result === 'string' ? JSON.parse(state.step5Result) : state.step5Result;
          if (step5Data && step5Data.data && step5Data.data.outputs && step5Data.data.outputs.content && Array.isArray(step5Data.data.outputs.content)) {
            step5Data.data.outputs.content.forEach((item, index) => {
              markdown += `### ${item.title || `检查项 ${index + 1}`}\n\n`;
              markdown += item.content + '\n\n';
            });
          } else if (step5Data && step5Data.content && Array.isArray(step5Data.content)) {
            step5Data.content.forEach((item, index) => {
              markdown += `### ${item.title || `检查项 ${index + 1}`}\n\n`;
              markdown += item.content + '\n\n';
            });
          } else {
            markdown += Utils.getResultContent(state.step5Result) + '\n\n';
          }
        } catch (e) {
          markdown += Utils.getResultContent(state.step5Result) + '\n\n';
        }
      }
      
      return markdown;
    }

    saveBtn.addEventListener('click', () => {
      // 保存当前状态（包括检查结果）
      const state = Store.getState();
      Store.setState({
        step5CheckType: checkType.value,
        step5UserReq: userReq.value.trim(),
        // 确保检查结果也被保存
        step5ChapterCheckResults: chapterCheckResults,
        step5GlobalCheckResult: globalCheckResult,
        step5Result: state.step5Result || currentResultData, // 保持原有的完整响应数据
        // 同时保存章节数据（如果用户编辑了）
        step4Result: state.step4Result // 保持步骤4的结果
      });
      window.location.href = 'step6-merge.html';
    });

    nextBtn.addEventListener('click', () => {
      window.location.href = 'step6-merge.html';
    });
  </script>
</body>
</html>

